export type StudentLocale = "en" | "ar";

export interface PublicAppSettings {
  default_language?: string | null;
  welcome_instructions?: string | null;
  welcome_instructions_ar?: string | null;
  thank_you_title?: string | null;
  thank_you_title_ar?: string | null;
  thank_you_message?: string | null;
  thank_you_message_ar?: string | null;
}

export function resolveStudentLocale(settings?: PublicAppSettings | null): StudentLocale {
  const lang = (settings?.default_language || "en").toLowerCase();
  return lang === "ar" ? "ar" : "en";
}

export function getDir(locale: StudentLocale): "ltr" | "rtl" {
  return locale === "ar" ? "rtl" : "ltr";
}

const dict: Record<StudentLocale, Record<string, string>> = {
  en: {
    loading_exam: "Loading exam...",
    loading_exam_hint: "Please wait while we prepare your exam",
    redirecting_results: "Redirecting to results...",
    system_unavailable: "System Unavailable",
    go_to_results: "Go to Results",
    unable_load_exam: "Unable to Load Exam",
    try_again: "Try Again",
    exam_not_started: "Exam Not Started",
    exam_available_on: "This exam will be available on {date}",
    exam_ended: "Exam Ended",
    exam_ended_on: "This exam ended on {date}",
    check_back_scheduled_time: "Please check back at the scheduled time.",
    exam_code: "Code",
    exam_code_hint: "Enter your 4-digit code",
    student_name: "Student Name",
    optional: "(optional)",
    name_placeholder: "Enter your full name",
    go_back: "Go Back",
    start_exam: "Start Exam",
    exam_information: "Exam Information",
    duration: "Duration:",
    minutes: "minutes",
    available_from: "Available from:",
    available_until: "Available until:",
    loading_instructions: "Loading instructions...",
    welcome_title: "Welcome, {name}!",
    welcome_hint: "Please read the instructions below before starting your exam",
    default_instructions_title: "Exam Instructions:",
    default_instruction_1: "Read each question carefully before answering",
    default_instruction_2: "Your progress is automatically saved as you work",
    default_instruction_3: "You can navigate between questions using the sidebar",
    default_instruction_4: "Make sure to submit your exam before the time limit",
    default_instruction_5: "If you experience technical issues, contact your instructor",
    thank_you: "Thank You!",
    submission_details: "Submission Details",
    exam_label: "Exam:",
    student_label: "Student:",
    submitted_label: "Submitted:",
    status_label: "Status:",
    completed: "✓ Completed",
    thank_you_default_message: "Your answers have been recorded and saved. You may now close this page or navigate away. Results will be available according to your instructor's schedule.",
    close_window: "Close Window",
    footer_good_luck: "Good luck with your exam!",
    help_contact_instructor: "If you have any questions about your submission, please contact your instructor.",
    starting_exam: "Starting Exam...",
    continue_to_exam: "Continue to Exam",
    loading_generic: "Loading...",
    unable_load_instructions: "Unable to Load Instructions",
    no_exams_available: "No exams are currently available. Please check back later.",
    err_code_required: "Please enter your code",
    err_student_name_required: "Please enter your name",
    err_invalid_code: "Invalid code. Please check and try again.",
    err_code_already_used: "This code has already been used",
    err_exam_not_published: "This exam is not currently available",
    err_exam_not_started: "This exam has not started yet",
    err_exam_ended: "This exam has ended",
    err_attempt_limit_reached: "You have reached the maximum number of attempts for this exam",
    err_ip_not_whitelisted: "Your location is not authorized to take this exam",
    err_ip_blacklisted: "Your location is blocked from taking this exam",
    // Results page strings
    results_unavailable: "Results Unavailable",
    results_portal_unavailable: "The results portal is currently unavailable. Please check back later.",
    go_home: "Go Home",
    exam_system: "Exam System",
    results_search_hint_code: "Search by your 4-digit code to see your results.",
    results_search_hint_name: "Search by your name to see your results.",
    code_must_be_4_digits: "Code must be exactly 4 digits",
    checking_code: "Checking code…",
    code_verified: "Code verified",
    code_not_found: "Code not found",
    searching: "Searching…",
    find_results: "Find Results",
    search_results: "Search Results",
    enter_code_to_view_results: "Enter your code to view your results.",
    enter_name_to_view_results: "Enter your name to view your results.",
    error_loading_results: "Error Loading Results",
    no_results_found: "No results found.",
    pass: "PASS",
    fail: "FAIL",
    // Attempt page & question component additions
    no_attempt_found: "No exam attempt found.",
    question_of_total: "Question {current} of {total}",
    x_answered: "{count} answered",
    offline: "Offline",
    auto_syncing: "Auto-syncing...",
    auto_saved: "Auto-saved",
    sync_failed: "Sync failed",
    auto_sync_enabled: "Auto-sync enabled",
    progress: "Progress",
    questions: "Questions",
    expand_sidebar: "Expand sidebar",
    collapse_sidebar: "Collapse sidebar",
    question_n: "Question {n}",
    answered: "Answered",
    previous: "Previous",
    save: "Save",
    submitting: "Submitting...",
    submit_exam: "Submit Exam",
    next: "Next",
    save_progress: "Save Progress",
    exam_submitted_successfully: "Exam Submitted Successfully",
    answers_recorded_close_hint: "Your answers have been recorded. You can now close this page.",
    submit_exam_q: "Submit Exam?",
    cannot_be_undone: "This action cannot be undone",
    total_questions: "Total Questions:",
    answered_label: "Answered:",
    unanswered_label: "Unanswered:",
    progress_label: "Progress:",
    warning: "Warning:",
    unanswered_warning: "You have {count} unanswered question(s). These will be marked as incorrect.",
    cancel: "Cancel",
    confirm_submit_exam: "Yes, Submit Exam",
    true: "True",
    false: "False",
    answered_paren: "(Answered)",
    clear_answer: "Clear answer",
    select_all_apply_with_count: "Select all that apply ({count} selected)",
    type_answer_here: "Type your answer here...",
    be_detailed: "Be as detailed as possible",
    characters_count: "{count} characters",
    unsupported_question_type: "Unsupported question type",
    points: "Points:",
    home: "Home",
    results: "Results",
    
    // Multi-exam selection UI
    select_exam: "Exam Access",
    find_exams: "Find Exams",
    exams_available_for_code: "Exams available for code {code}",
    exams_available_for_student: "Exams available for {name}",
    no_exams_for_code: "No exams available for this code.",
    change_code: "Change Code",
    more_exams_available: "More exams are available for your code.",
    returning_to_exam_selection: "Returning to exam selection...",
    go_to_exam_selection: "Go to exam selection",
    
    // Time warnings
    time_warning: "Time Warning",
    one_hour_remaining: "Only 1 hour remaining! Please manage your time carefully.",
    thirty_minutes_remaining: "Only 30 minutes remaining! Please review your answers.",
    fifteen_minutes_remaining: "Only 15 minutes remaining! Please finish up soon.",
    five_minutes_remaining: "Only 5 minutes remaining! Please submit your exam soon.",
    one_minute_remaining: "Only 1 minute remaining! The exam will auto-submit soon.",
    understood: "Understood",
  },
  ar: {
    loading_exam: "جاري تحميل الاختبار...",
    loading_exam_hint: "يرجى الانتظار بينما نقوم بتحضير الاختبار",
    redirecting_results: "يتم تحويلك إلى صفحة النتائج...",
    system_unavailable: "النظام غير متاح",
    go_to_results: "اذهب إلى النتائج",
    unable_load_exam: "تعذر تحميل الاختبار",
    try_again: "حاول مرة أخرى",
    exam_not_started: "لم يبدأ الاختبار",
    exam_available_on: "سيكون الاختبار متاحًا في {date}",
    exam_ended: "انتهى الاختبار",
    exam_ended_on: "انتهى هذا الاختبار في {date}",
    check_back_scheduled_time: "يرجى العودة في الموعد المحدد.",
    exam_code: "الكود",
    exam_code_hint: "أدخل الكود المكوّن من 4 أرقام",
    student_name: "اسم الطالب",
    optional: "(اختياري)",
    name_placeholder: "أدخل اسمك الكامل",
    go_back: "عودة",
    start_exam: "ابدأ الاختبار",
    exam_information: "معلومات الاختبار",
    duration: "المدة:",
    minutes: "دقائق",
    available_from: "متاح من:",
    available_until: "متاح حتى:",
    loading_instructions: "جاري تحميل التعليمات...",
    welcome_title: "مرحبًا، {name}!",
    welcome_hint: "يرجى قراءة التعليمات التالية قبل بدء الاختبار",
    default_instructions_title: "تعليمات الاختبار:",
    default_instruction_1: "اقرأ كل سؤال بعناية قبل الإجابة",
    default_instruction_2: "يتم حفظ تقدمك تلقائيًا أثناء العمل",
    default_instruction_3: "يمكنك التنقل بين الأسئلة باستخدام الشريط الجانبي",
    default_instruction_4: "تأكد من إرسال الاختبار قبل انتهاء الوقت",
    default_instruction_5: "إذا واجهت مشاكل تقنية، تواصل مع المشرف",
    thank_you: "شكرًا لك!",
    submission_details: "تفاصيل الإرسال",
    exam_label: "الاختبار:",
    student_label: "الطالب:",
    submitted_label: "تاريخ الإرسال:",
    status_label: "الحالة:",
    completed: "✓ تم الإكمال",
    thank_you_default_message: "تم تسجيل إجاباتك وحفظها. يمكنك الآن إغلاق هذه الصفحة أو الانتقال بعيدًا. ستتوفر النتائج حسب جدول المشرف.",
    close_window: "إغلاق النافذة",
    footer_good_luck: "حظًا موفقًا في الاختبار!",
    help_contact_instructor: "إذا كانت لديك أي أسئلة حول إرسال الإجابات، يرجى التواصل مع المشرف.",
    starting_exam: "جارٍ بدء الاختبار...",
    continue_to_exam: "المتابعة إلى الاختبار",
    loading_generic: "جاري التحميل...",
    unable_load_instructions: "تعذر تحميل التعليمات",
    no_exams_available: "لا توجد اختبارات متاحة حاليًا. يرجى المحاولة لاحقًا.",
    err_code_required: "يرجى إدخال رمز الاختبار",
    err_student_name_required: "يرجى إدخال اسمك",
    err_invalid_code: "رمز الاختبار غير صالح. يرجى التحقق والمحاولة مرة أخرى.",
    err_code_already_used: "تم استخدام رمز الاختبار هذا مسبقًا",
    err_exam_not_published: "هذا الاختبار غير متاح حاليًا",
    err_exam_not_started: "لم يبدأ هذا الاختبار بعد",
    err_exam_ended: "انتهى هذا الاختبار",
    err_attempt_limit_reached: "لقد وصلت إلى الحد الأقصى لعدد المحاولات لهذا الاختبار",
    err_ip_not_whitelisted: "موقعك غير مُصرّح له بأداء هذا الاختبار",
    err_ip_blacklisted: "موقعك محظور من أداء هذا الاختبار",
    // Results page strings
    results_unavailable: "النتائج غير متاحة",
    results_portal_unavailable: "بوابة النتائج غير متاحة حاليًا. يرجى المحاولة لاحقًا.",
    go_home: "العودة إلى الصفحة الرئيسية",
    exam_system: "نظام الاختبارات",
    results_search_hint_code: "ابحث بواسطة رمز الاختبار المكوّن من 4 أرقام لعرض نتائجك.",
    results_search_hint_name: "ابحث بواسطة اسمك لعرض نتائجك.",
    code_must_be_4_digits: "يجب أن يتكون الرمز من 4 أرقام بالضبط",
    checking_code: "جارٍ التحقق من الرمز…",
    code_verified: "تم التحقق من الرمز",
    code_not_found: "لم يتم العثور على الرمز",
    searching: "جارٍ البحث…",
    find_results: "اعرض النتائج",
    search_results: "بحث عن النتائج",
    enter_code_to_view_results: "أدخل رمز الاختبار لعرض نتائجك.",
    enter_name_to_view_results: "أدخل اسمك لعرض نتائجك.",
    error_loading_results: "خطأ في تحميل النتائج",
    no_results_found: "لم يتم العثور على نتائج.",
    pass: "ناجح",
    fail: "راسب",
    // Attempt page & question component additions
    no_attempt_found: "لم يتم العثور على محاولة للاختبار.",
    question_of_total: "السؤال {current} من {total}",
    x_answered: "{count} تمت الإجابة",
    offline: "غير متصل",
    auto_syncing: "جارٍ المزامنة التلقائية...",
    auto_saved: "تم الحفظ تلقائيًا",
    sync_failed: "فشلت المزامنة",
    auto_sync_enabled: "المزامنة التلقائية مفعّلة",
    progress: "التقدم",
    questions: "الأسئلة",
    expand_sidebar: "توسيع الشريط الجانبي",
    collapse_sidebar: "طي الشريط الجانبي",
    question_n: "السؤال {n}",
    answered: "تمت الإجابة",
    previous: "السابق",
    save: "حفظ",
    submitting: "جارٍ الإرسال...",
    submit_exam: "إرسال الاختبار",
    next: "التالي",
    save_progress: "حفظ التقدم",
    exam_submitted_successfully: "تم إرسال الاختبار بنجاح",
    answers_recorded_close_hint: "تم تسجيل إجاباتك. يمكنك الآن إغلاق هذه الصفحة.",
    submit_exam_q: "هل تريد إرسال الاختبار؟",
    cannot_be_undone: "لا يمكن التراجع عن هذا الإجراء",
    total_questions: "إجمالي الأسئلة:",
    answered_label: "المجاب:",
    unanswered_label: "غير المُجاب:",
    progress_label: "التقدم:",
    warning: "تحذير:",
    unanswered_warning: "لديك {count} سؤال غير مُجاب. سيتم اعتباره غير صحيح.",
    cancel: "إلغاء",
    confirm_submit_exam: "نعم، إرسال الاختبار",
    true: "صحيح",
    false: "خطأ",
    answered_paren: "(تمت الإجابة)",
    clear_answer: "مسح الإجابة",
    select_all_apply_with_count: "اختر كل ما ينطبق ({count} محدد)",
    type_answer_here: "اكتب إجابتك هنا...",
    be_detailed: "كن مفصلًا قدر الإمكان",
    characters_count: "{count} حرف",
    unsupported_question_type: "نوع السؤال غير مدعوم",
    points: "الدرجات:",
    home: "الصفحة الرئيسية",
    results: "النتائج",
    
    // Multi-exam selection UI
    select_exam: "دخول الاختبار",
    find_exams: "اعرض الاختبارات",
    exams_available_for_code: "الاختبارات المتاحة للرمز {code}",
    exams_available_for_student: "الاختبارات المتاحة للطالب {name}",
    no_exams_for_code: "لا توجد اختبارات متاحة لهذا الرمز.",
    change_code: "تغيير الرمز",
    more_exams_available: "هناك اختبارات أخرى متاحة لرمزك.",
    returning_to_exam_selection: "سيتم إعادتك إلى اختيار الاختبار...",
    go_to_exam_selection: "العودة لاختيار الاختبار",
    
    // Time warnings
    time_warning: "تحذير الوقت",
    one_hour_remaining: "باقي ساعة واحدة فقط! يرجى إدارة وقتك بعناية.",
    thirty_minutes_remaining: "باقي 30 دقيقة فقط! يرجى مراجعة إجاباتك.",
    fifteen_minutes_remaining: "باقي 15 دقيقة فقط! يرجى الانتهاء قريباً.",
    five_minutes_remaining: "باقي 5 دقائق فقط! يرجى تسليم الامتحان قريباً.",
    one_minute_remaining: "باقي دقيقة واحدة فقط! سيتم تسليم الامتحان تلقائياً قريباً.",
    understood: "مفهوم",
  },
};

export function t(locale: StudentLocale, key: string, vars?: Record<string, string | number>): string {
  const template = dict[locale][key] || dict.en[key] || key;
  if (!vars) return template;
  return Object.keys(vars).reduce((acc, k) => acc.replace(new RegExp(`\\{${k}\\}`, "g"), String(vars[k])), template);
}
